@page
@model IndexModel
@{
  ViewData["Title"] = "SLA Dashboard";
}
<div style="font-family:system-ui, -apple-system, Segoe UI, Roboto; padding:24px; max-width:1100px; margin:0 auto;">
  <h1 style="margin-bottom:16px;">SLA Dashboard</h1>
  <p style="color:#666; margin-bottom:24px;">Live KPIs from your tickets dataset.</p>

  <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:24px;">
    <div id="kpi-open" style="background:#f5f7ff; padding:16px; border-radius:10px;"></div>
    <div id="kpi-21" style="background:#fff7e6; padding:16px; border-radius:10px;"></div>
    <div id="kpi-7" style="background:#fff1f0; padding:16px; border-radius:10px;"></div>
    <div id="kpi-overdue" style="background:#ffe6e6; padding:16px; border-radius:10px;"></div>
  </div>

  <a href="/Tickets"
    style="display:inline-block; padding:10px 14px; background:#0a7; color:white; border-radius:8px; text-decoration:none;">View
    Tickets →</a>

  <!-- KPI tiles -->
  <div id="kpis" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px;">
    <div style="padding:16px;border:1px solid #eee;border-radius:10px;background:#fafafa;">
      <div>Open</div>
      <div id="kpi-open" style="font-size:28px;font-weight:700;">—</div>
    </div>
    <div style="padding:16px;border:1px solid #eee;border-radius:10px;background:#fafafa;">
      <div>Due ≤ 21d</div>
      <div id="kpi-21" style="font-size:28px;font-weight:700;">—</div>
    </div>
    <div style="padding:16px;border:1px solid #eee;border-radius:10px;background:#fafafa;">
      <div>Due ≤ 7d</div>
      <div id="kpi-7" style="font-size:28px;font-weight:700;">—</div>
    </div>
    <div style="padding:16px;border:1px solid #eee;border-radius:10px;background:#fafafa;">
      <div>Overdue</div>
      <div id="kpi-od" style="font-size:28px;font-weight:700;color:#b00020;">—</div>
    </div>
  </div>

  <!-- AI Executive Summary card -->
  <div id="ai-card" style="margin-top:20px;padding:16px;border:1px solid #eee;border-radius:10px;background:#f6fbff;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <h2 style="margin:0;">AI Executive Summary</h2>
      <button id="refresh-summary"
        style="padding:8px 12px;border:none;border-radius:8px;background:#0369a1;color:#fff;cursor:pointer;">
        Refresh
      </button>
    </div>
    <pre id="ai-summary"
      style="white-space:pre-wrap;font-family:system-ui, -apple-system, Segoe UI, Roboto;margin-top:12px;">Loading...</pre>
  </div>

  <!-- Tickets Heatmap -->
  <div style="margin-top:20px;padding:16px;border:1px solid #eee;border-radius:10px;background:#f6fbff;">
    <h2 style="margin:0 0 12px 0;">Tickets Heatmap by Data Center</h2>

    <div style="font-size:14px;margin-bottom:12px;display:flex;gap:12px;align-items:center;">
      <span><b>Legend:</b></span>
      <span style="padding:4px 8px;background:#fee2e2;border:1px solid #fecaca;border-radius:6px;">Overdue
        (&lt;0d)</span>
      <span style="padding:4px 8px;background:#fef9c3;border:1px solid #fde68a;border-radius:6px;">≤ 7d</span>
      <span style="padding:4px 8px;background:#fffbeb;border:1px solid #fde68a;border-radius:6px;">8–21d</span>
      <span style="padding:4px 8px;background:#dcfce7;border:1px solid #bbf7d0;border-radius:6px;">&gt; 21d</span>
    </div>

    <table id="heatmap" style="width:100%;border-collapse:separate;border-spacing:0 8px;">
      <thead>
        <tr style="text-align:left;">
          <th style="padding:8px;">Data Center</th>
          <th style="padding:8px;">Overdue</th>
          <th style="padding:8px;">≤ 7d</th>
          <th style="padding:8px;">8–21d</th>
          <th style="padding:8px;">&gt; 21d</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Drill-down: filters + AI summary + table -->
<div id="dc-tickets-section" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <h3 id="dc-tickets-title" style="margin-bottom:8px;"></h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <label>Priority:
        <select id="filter-priority">
          <option value="">All</option>
          <option>High</option>
          <option>Medium</option>
          <option>Low</option>
        </select>
      </label>
      <label>Category:
        <select id="filter-category">
          <option value="">All</option>
          <option>Networking</option>
          <option>Security</option>
          <option>Compliance</option>
          <option>PowerCooling</option>
        </select>
      </label>
      <button id="clear-filters"
        style="padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;">
        Clear
      </button>
    </div>
  </div>

  <!-- AI summary for this DC -->
  <div id="dc-ai-card"
    style="margin-top:10px;padding:12px;border:1px solid #eee;border-radius:10px;background:#f6fbff;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <h4 style="margin:0;">AI Summary for this DC</h4>
      <button id="refresh-dc-summary"
        style="padding:6px 10px;border:none;border-radius:8px;background:#0369a1;color:#fff;cursor:pointer;">Refresh</button>
    </div>
    <pre id="dc-ai-summary" style="white-space:pre-wrap;margin:8px 0 0 0;">—</pre>
  </div>

  <!-- DC tickets table card -->
  <div style="margin-top:10px;padding:12px;border:1px solid #eee;border-radius:10px;background:#f6fbff;">
    <table id="dc-tickets" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr style="text-align:left;">
          <th class="sortable" data-key="ticketId" style="padding:8px;cursor:pointer;">Ticket ID</th>
          <th class="sortable" data-key="docCategory" style="padding:8px;cursor:pointer;">Category</th>
          <th class="sortable" data-key="dueInDays" style="padding:8px;cursor:pointer;">Due In (days)</th>
          <th class="sortable" data-key="priority" style="padding:8px;cursor:pointer;">Priority</th>
          <th style="padding:8px;">Owner</th>
          <th style="padding:8px;">Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>


<script>
  // ---- KPIs + top-level AI summary ----
  async function loadKpis() {
    try {
      const r = await fetch('/api/kpi/summary');
      const j = await r.json();
      // Big tiles (card-style)
      const card = (label, value) => `
        <div style="display:flex; flex-direction:column;">
          <span style="font-size:13px; color:#555">${label}</span>
          <strong style="font-size:28px;">${value}</strong>
        </div>`;
      document.getElementById('kpi-open').innerHTML = card('Open Tickets', j.open ?? '—');
      document.getElementById('kpi-21').innerHTML = card('Due ≤ 21 days', j.dueIn21 ?? '—');
      document.getElementById('kpi-7').innerHTML = card('Due ≤ 7 days', j.dueIn7 ?? '—');
      document.getElementById('kpi-overdue').innerHTML = card('Overdue', j.overdue ?? '—');

      // Small number tiles
      document.getElementById('kpi-open').textContent = j.open ?? '—';
      document.getElementById('kpi-21').textContent = j.dueIn21 ?? '—';
      document.getElementById('kpi-7').textContent = j.dueIn7 ?? '—';
      const od = document.getElementById('kpi-od');
      if (od) od.textContent = j.overdue ?? '—';
    } catch {
      ['kpi-open', 'kpi-21', 'kpi-7', 'kpi-od'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = 'ERR';
      });
    }
  }

  async function loadSummary() {
    try {
      const r = await fetch('/api/ai/summary');
      const j = await r.json();
      document.getElementById('ai-summary').textContent = j.summary || 'No summary available.';
    } catch {
      document.getElementById('ai-summary').textContent = 'Error loading summary.';
    }
  }



  // ---- Heatmap ----
  async function loadHeatmap() {
    const tbody = document.querySelector('#heatmap tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;color:#666;">Loading…</td></tr>';
    try {
      const r = await fetch('/api/tickets/heatmap');
      const rows = await r.json();
      if (!Array.isArray(rows) || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;color:#666;">No open tickets.</td></tr>';
        return;
      }
      const chip = (val, bg, bd) =>
        `<span style="display:inline-block;min-width:36px;text-align:center;padding:6px 10px;background:${bg};border:1px solid ${bd};border-radius:10px;font-weight:600;">${val}</span>`;
      tbody.innerHTML = rows.map(x => `
        <tr>
          <td style="padding:8px;font-weight:600;color:#2563eb;cursor:pointer;text-decoration:underline;"
              onclick="loadDcTickets('${x.dcId}')">${x.dcId}</td>
          <td style="padding:8px;">${chip(x.overdue, '#fee2e2', '#fecaca')}</td>
          <td style="padding:8px;">${chip(x.due7, '#fef9c3', '#fde68a')}</td>
          <td style="padding:8px;">${chip(x.due21, '#fffbeb', '#fde68a')}</td>
          <td style="padding:8px;">${chip(x.ok, '#dcfce7', '#bbf7d0')}</td>
        </tr>`).join('');
    } catch {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:8px;color:#b00020;">Error loading heatmap.</td></tr>';
    }
  }

  // ---- Drill-down (filters + sorting + per-DC AI) ----
  let _dcRows = [];
  let _sortKey = 'dueInDays';
  let _sortAsc = true;
  let _currentDcId = null;

  function renderDcTable() {
    const pri = document.getElementById('filter-priority').value;
    const cat = document.getElementById('filter-category').value;
    let rows = _dcRows.slice();

    if (pri) rows = rows.filter(r => (r.priority || '').toLowerCase() === pri.toLowerCase());
    if (cat) rows = rows.filter(r => (r.docCategory || '').toLowerCase() === cat.toLowerCase());

    rows.sort((a, b) => {
      const va = a[_sortKey], vb = b[_sortKey];
      const na = typeof va === 'number' ? va : isNaN(+va) ? (va ?? '').toString().toLowerCase() : +va;
      const nb = typeof vb === 'number' ? vb : isNaN(+vb) ? (vb ?? '').toString().toLowerCase() : +vb;
      if (typeof na === 'number' && typeof nb === 'number') return _sortAsc ? (na - nb) : (nb - na);
      if (na < nb) return _sortAsc ? -1 : 1;
      if (na > nb) return _sortAsc ? 1 : -1;
      return 0;
    });

    const tbody = document.querySelector('#dc-tickets tbody');
    tbody.innerHTML = rows.map(t => `
      <tr>
        <td style="padding:8px;">${t.ticketId}</td>
        <td style="padding:8px;">${t.docCategory}</td>
        <td style="padding:8px;">${t.dueInDays}</td>
        <td style="padding:8px;">${t.priority}</td>
        <td style="padding:8px;">${t.owner || ''}</td>
        <td style="padding:8px;">${t.status}</td>
      </tr>`).join('');
  }

  async function loadDcTickets(dcId) {
    _currentDcId = dcId;
    document.getElementById('dc-tickets-section').style.display = 'block';
    document.getElementById('dc-tickets-title').innerText = `Open Tickets for ${dcId}`;
    document.querySelector('#dc-tickets tbody').innerHTML =
      '<tr><td colspan="6" style="padding:8px;color:#666;">Loading…</td></tr>';
    try {
      const r = await fetch(`/api/tickets/by-dc/${encodeURIComponent(dcId)}`);
      _dcRows = await r.json();
      renderDcTable();
    } catch {
      document.querySelector('#dc-tickets tbody').innerHTML =
        '<tr><td colspan="6" style="padding:8px;color:#b00020;">Error loading tickets.</td></tr>';
    }
    loadDcSummary(dcId);
  }

  document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('sortable')) return;
    const key = e.target.getAttribute('data-key');
    if (_sortKey === key) _sortAsc = !_sortAsc; else { _sortKey = key; _sortAsc = true; }
    renderDcTable();
  });

  document.addEventListener('change', (e) => {
    if (e.target.id === 'filter-priority' || e.target.id === 'filter-category') renderDcTable();
  });

  document.addEventListener('click', (e) => {
    if (e.target.id === 'clear-filters') {
      document.getElementById('filter-priority').value = '';
      document.getElementById('filter-category').value = '';
      renderDcTable();
    }
  });

  async function loadDcSummary(dcId) {
    try {
      document.getElementById('dc-ai-summary').textContent = 'Loading…';
      const r = await fetch(`/api/ai/summary/${encodeURIComponent(dcId)}`);
      const j = await r.json();
      document.getElementById('dc-ai-summary').textContent = j.summary || 'No summary.';
    } catch {
      document.getElementById('dc-ai-summary').textContent = 'Error loading summary.';
    }
  }

  document.getElementById('refresh-summary').addEventListener('click', loadSummary);
  document.addEventListener('click', (e) => {
    if (e.target.id === 'refresh-dc-summary' && _currentDcId) loadDcSummary(_currentDcId);
  });

  // Run when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    loadKpis();
    loadSummary();
    loadHeatmap();
  });
</script>
